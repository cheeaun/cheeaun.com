<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>Building Check Weather SG &ndash; Lim Chee Aun</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preload" href="/assets/fonts/WorkSans-Regular.woff2" as="font" type="font/woff2">
<style>html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body,button,html,input,select,textarea{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}code,kbd,pre,samp,var{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}a{text-decoration:none}a:hover{text-decoration:underline}a img,img{border:0}h1,h2,h3,h4,h5,h6{margin:0;padding:0}p{padding:0}caption{font-weight:700;padding:.5em}table{border-collapse:collapse;border-spacing:0}td,th{vertical-align:top}ol,ul{padding:0}dt{font-weight:700}dfn{font-style:normal;font-weight:700}abbr{border-bottom:1px dotted}form{margin:0;padding:0}legend{font-weight:700}button,input,select,textarea{font-size:1em;max-width:100%;vertical-align:middle;margin:0}textarea{overflow:auto}button,input.button{padding:0 .5em;overflow:visible}article,aside,details,figcaption,figure,footer,header,hgroup,nav,section,summary{display:block}@font-face{font-family:'Work Sans';font-style:normal;font-weight:400;font-display:swap;src:url(/assets/fonts/WorkSans-Regular.woff2) format('woff2')}@font-face{font-family:'Work Sans';font-style:italic;font-weight:400;font-display:swap;src:url(/assets/fonts/WorkSans-Italic.woff2) format('woff2')}@font-face{font-family:'Work Sans';font-style:normal;font-weight:500;font-display:swap;src:url(/assets/fonts/WorkSans-Medium.woff2) format('woff2')}@font-face{font-family:'Work Sans';font-style:italic;font-weight:500;font-display:swap;src:url(/assets/fonts/WorkSans-MediumItalic.woff2) format('woff2')}body,html{overflow-x:hidden}body{color:#444;background-color:#fff;padding:0;margin:0;font-family:'Work Sans',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px}a{color:#0b62a0;padding:.25em;margin:-.25em;border-radius:3px;text-decoration:underline;text-underline-offset:1px;text-decoration-color:#0b62a061}a:hover{color:#000;text-decoration:underline}a:focus{color:#000;background-color:rgba(0,0,0,.08);text-decoration:none}b,dt,strong,th{font-weight:500}li,p{line-height:1.5em}ol,ul{margin-left:1.35em}img,video{max-width:100%;height:auto;background-color:#fafafa}p strong{color:#000}p a strong{color:inherit}code,kbd,samp,var{background-color:#fafafa;font-size:.9em}:not(pre)>code,:not(pre)>kbd,:not(pre)>samp,:not(pre)>var{color:#08632c;background-color:transparent}:not(pre)>code:before,:not(pre)>kbd:before,:not(pre)>samp:before,:not(pre)>var:before{content:'`';opacity:.5}:not(pre)>code:after,:not(pre)>kbd:after,:not(pre)>samp:after,:not(pre)>var:after{content:'`';opacity:.5}pre code{background-color:auto}#container{position:relative;margin:auto;max-width:40em;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word}#container pre{word-wrap:normal;overflow-wrap:normal;word-break:normal}header{text-align:center;padding:50px}header h1{margin:0}header h1 a{display:inline-block;border-radius:50%}header h1 a:focus{transform:scale(.97)}header svg{vertical-align:top}header h1 a:focus svg{-webkit-filter:brightness(.9);filter:brightness(.9)}#content{padding:0 1em}#content h1{font-size:44px;line-height:1.2em;margin:0 0 .5em;text-align:center;letter-spacing:-.05em;font-weight:500}#content header{text-align:left;padding:0;background-image:none}#content article h1+time{display:block;text-align:center;padding:0 0 4em;color:#767676}#content h2{font-size:32px;letter-spacing:-.05em;font-weight:500;color:#333;margin:0 0 .75em;line-height:1.2em}#content *+h2{margin-top:1.5em}#content article.summary h2{margin-bottom:.5em}#content article.summary time{color:#767676;display:block;margin:0 0 .75em}#content p{margin:0 0 1em}#content ol,#content ul{margin-bottom:1em}#content dt{margin-bottom:1em;color:#000}#content dd{margin-left:1.35em}#content pre{margin:0 0 1em;border-radius:3px;padding:1em;background-color:#f3f3f3;font-size:.9em;line-height:1.5em;overflow:auto}#content pre code,#content pre kbd,#content pre samp,#content pre var{background-color:inherit}#content pre em,#content pre strong{color:red;font-style:normal}#content pre em.remark{color:#767676;font-style:normal}#content pre var{color:#060;font-style:normal}#content blockquote{border-left:3px solid #999;padding:.6em 0 .6em 1em;margin:0 0 2em}#content blockquote p:last-child{margin-bottom:0}#content table{margin:0 auto 1em;border:1px solid #ddd}#content table td,#content table th{padding:.5em .9em}#content table thead th{text-align:center;background-color:#eee}#content table tbody th{text-align:left}#content table tbody tr:nth-child(even){background-color:#fafafa}#content aside{padding:5px 10px}#content aside,#content aside p{line-height:28px;background-color:#fff5d9;text-align:right}.pinyin{font-style:italic}.remark{font-style:italic;color:#767676}:lang(ms){font-style:italic}#content figure{text-align:center;margin:1em -1em}#content *+figure{margin-top:2em;margin-bottom:2em}#content time+figure{margin-top:0}#content figure.image-aside{margin:0 0 1em 1em;padding:10px;background-color:rgba(255,255,255,.5);float:right;clear:right}#content figure img.large{max-width:100vw;position:relative;left:50%;transform:translateX(-50%)}#content blockquote figure img.large{left:calc(50% - 10px)}#content figure a{padding:0;margin:0;border:0}#content figure a img{vertical-align:bottom}#content figure a:focus img{-webkit-filter:brightness(.9);filter:brightness(.9)}#content video{display:block;margin:auto}#content hr{border:0;border-top:1px solid #ccc;margin:2em}footer{padding:50px;text-align:center;color:#767676}footer a{color:inherit}footer nav ul{list-style:none;display:block;margin:0 0 20px}footer nav ul li{display:inline}footer nav ul li a{margin:0 .25em}#blog-archives ul{list-style:none;margin:0 -1em}#blog-archives ul li{padding:.5em 1em}#blog-archives ul li:nth-child(even){background-color:#fafafa}#blog-archives time{float:right;margin-left:1em}@-ms-viewport{width:device-width;zoom:1.0}@viewport{width:device-width;zoom:1.0}@media print{footer{display:none}#content a[href]{text-decoration:none}#content a[href]:after{content:" (" attr(href) ") ";font-size:90%}blockquote,figure,img,li,p,pre,video{break-inside:avoid;page-break-inside:avoid}h2,h3{break-after:avoid-page;page-break-after:avoid}p{orphans:2;widows:2}}</style>
<meta name="twitter:card" content="summary">
<meta property="og:title" content="Building Check Weather SG">
<meta name="description" property="og:description" content="Over the past 9 years, since the day I step foot into Singapore, I&#x27;ve never even once seen a reliable weather forecast for Singapore. Singaporeâ€¦">
<meta property="og:image" content="https://cheeaun.com/blog/images/photos/objects/check-weather-sg-visual-code-macbook.jpg">
<link rel="alternate" href="/blog/feed.xml" type="application/atom+xml" title="cheeaunblog">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="apple-touch-icon" href="/assets/images/icon-192.png">
<meta name="theme-color" content="#fff"><div id="container">
  <header role="banner">
    <h1>
      <a href="/"><svg width="120" height="120" viewBox="0 0 225 225">
    <title>Lim Chee Aun</title>
    <circle cx="112.5" cy="112.5" r="112.5" fill="#fa8e01"/>
    <path fill="#fff" d="M104.8 127.1c-.8.4-1.9.9-3 1.3-1.2.5-2.4.9-3.6 1.2-1.2.3-2.3.5-3.3.5-3 0-5.3-1.5-7-4.7-1.6-3.1-2.5-7.8-2.5-13.9 0-4.3.4-7.6 1.2-9.9.7-2.3 1.8-4 3.2-4.9 1.3-1 2.9-1.4 4.7-1.3 1.2-.1 2.7.1 4.4.5 1.8.4 3.7 1.1 5.7 2.2l3.3-15.5c-2.7-.9-5.3-1.5-8-1.9-2.5-.3-4.8-.5-6.8-.5-5.8 0-10.7 1.1-14.8 3.3-4.1 2.2-7.2 5.7-9.4 10.7-2.1 4.8-3.2 11.2-3.3 19.2 0 10.8 2.1 18.8 6.3 24 4.1 5.2 10.2 7.8 18.3 7.8 2.2 0 4.4-.1 6.6-.5 2.2-.3 4.3-.8 6.3-1.4 2-.6 3.7-1.3 5.2-2.1l-3.5-14.1zm54.5 16.9c-.2-1.8-.5-3.8-.8-6.1-.2-2.2-.4-4.5-.6-7-.2-2.4-.3-4.9-.3-7.3v-23c0-2.9-.3-5.6-1-8.1-.6-2.5-1.8-4.7-3.3-6.6-1.6-1.9-3.9-3.4-6.7-4.5-2.8-1-6.3-1.6-10.6-1.6-3.5 0-7.1.4-10.7 1.1-3.6.8-7.3 1.8-11 3.1l3.7 14c3.1-1.2 5.8-2.1 8.2-2.8 2.5-.6 4.5-.9 6.1-.9 1.8 0 3.3.5 4.4 1.4 1.2 1 1.8 2.6 1.8 4.9v7.7c-3.8.3-7.2.8-10.4 1.6s-6 1.9-8.4 3.3c-2.4 1.5-4.3 3.4-5.7 5.8-1.3 2.3-2 5.1-2 8.5 0 2.3.2 4.5.7 6.7.5 2.1 1.3 4 2.4 5.6 1.1 1.7 2.5 3 4.1 3.9 1.7 1 3.6 1.5 5.9 1.5 2.6 0 4.9-.4 6.9-1.2 2.1-.8 3.9-1.8 5.6-2.9 1.6-1.1 3.1-2.2 4.6-3.3l1.5 6.2h15.6zm-20.7-14.9c-.9.8-1.8 1.4-2.6 1.9s-1.6.7-2.5.7c-1.4 0-2.5-.6-3.4-1.8-.8-1.2-1.3-2.8-1.3-5 0-1.7.5-2.9 1.4-3.8 1-.8 2.2-1.4 3.7-1.7 1.5-.3 3-.6 4.7-.7v10.4z"/>
    <circle cx="112.5" cy="112.5" r="83.7" fill="none" stroke="#fff" stroke-width="20.1"/>
  </svg>
  </a>
    </h1>
  </header>
  <div id="content">
    <article itemscope itemtype="http://schema.org/BlogPosting">
      <header><h1 itemprop="heading">Building Check Weather SG</h1><time datetime="2018-06-08" class="meta date" itemprop="datePublished">8 June 2018</time></header><div itemprop="articleBody"><figure><img src="/blog/images/photos/objects/check-weather-sg-visual-code-macbook.jpg" alt="Check Weather SG website and Visual Code editor, on Macbook" width="2016" height="1512" loading="lazy" class="large"></figure><p>Over the past 9 years, since the day I step foot into Singapore, I&apos;ve never even once seen a reliable weather forecast for Singapore. Singapore is only a tiny island on the world map and it&apos;s nearly impossible to predict or forecast the weather. It&apos;s always either rainy &#x1F327; or sunny &#x1F31E;. Or <em>(cough)</em> hazy &#x1F32B;.</p><p>Somehow this reminds me of 4 years ago, when I flew to San Francisco for the first time, when the weather potentially became a viable topic for day-to-day conversations, I always use this cool web app called <a href="https://www.theverge.com/2016/9/20/12994194/dark-sky-website-launches">Forecast.io (now called Dark Sky)</a> which gives pretty <em>scarily</em> accurate weather forecast, including temperature changes, wind speed and precipitation. Some people told me that San Francisco has this unique micro-climates going on, for example, as you walk around the city, temperatures could drop dramatically and suddenly becomes warm after that. Also not forgetting, <a href="https://twitter.com/KarlTheFog">Karl the fog</a> &#x1F609;.</p><p>I personally find this quite amazing for a city as <em>huge</em> as San Francisco, but oh, wait, wait the minute&#x2026; it&apos;s not huge at all. Turns out, it&apos;s <a href="https://thetruesize.com/#?borders=1~!MTI3OTAxMDA.MTI3NTQ2MzQ*NTc5NjcwMg(NTcwODgxMQ~!SG*MTM1OTc1NDQ.MjIyNDIyMzk)Mw">smaller than Singapore</a> &#x1F605;</p><figure><a href="https://thetruesize.com/#?borders=1~!MTI3OTAxMDA.MTI3NTQ2MzQ*NTc5NjcwMg(NTcwODgxMQ~!SG*MTM1OTc1NDQ.MjIyNDIyMzk)Mw"><img src="/blog/images/screenshots/web/the-true-size-of-singapore-san-francisco.png" alt="The true size of &#x2026; Singapore and San Francisco; Singapore (blue region) being 3 times larger and overlapping on top of San Francisco" width="1000" height="536"></a></figure><p>Like, way, <em>way</em> smaller. That blue region is Singapore. &#x1F525; <strong>Burn</strong> this image into your mind.</p><p>Here&apos;s the question(s). How could a smaller city gets a much more accurate weather forecast than a bigger city/country? Is it because of the satellites? Is it because of the geography? Does the size even matter?! &#x1F914;&#x1F914;&#x1F914;</p><p>I don&apos;t have the answers. &#x1F937;&#x200D;&#x2642;&#xFE0F;</p><p>However recently I found that some brilliant people I know, including myself &#x1F9D0;, start to use <a href="http://www.weather.gov.sg/">Weather.gov.sg</a> for the most <em>reliable</em> weather forecast in Singapore.</p><figure><img src="/blog/images/screenshots/web/weather-gov-sg-web-site-nowcast-rain-areas.png" alt="Weather.gov.sg web site showing 2-hour Nowcast and Current Rain Areas" width="1024" height="768"></figure><p>Nope, not the <a href="http://www.weather.gov.sg/weather-forecast-2hrnowcast-2/">2-hour Nowcast</a> (on the left). Not the <a href="http://www.weather.gov.sg/weather-forecast-24hrforecast/">24-hour Forecast</a> either. It&apos;s the <a href="http://www.weather.gov.sg/weather-rain-area-50km/">50-km rain area radar images</a> (on the right) instead.</p><p>Most of the time, the only weather that matters is whether it rains or not, because that affects the road traffic and people traffic around Singapore, <em>especially</em> during peak hours.</p><p>From the radar images, it shows rain areas which tells exactly where in Singapore to&#x2026; <strong>avoid</strong>. It&apos;s useful for public transport users, so that they can avoid people traffic in the stations or the bus stops. Taxi riders can choose a different spot to pick up cabs or decide their next stop based on the <em>shapes</em> of the rain areas. Motorcyclists and vehicle drivers can avoid the rain by taking different routes as they would expect traffic jams in those areas. Also, for motorcyclists and cyclists, they would need to reroute so that they don&apos;t have to wear raincoats or stuck under a bridge. &#x1F609;</p><p>By looking at the radar animation, people could roughly guess <em>where</em> the rain is heading to. In other words, they are not even relying on the provided forecast information, they are literally <strong>forecasting the weather themselves!</strong> &#x1F4A5;</p><p>Thinking about it, it <em>does</em> make sense. If the forecast is not 100% accurate, better leave that judgment to yourself&#x2026;? &#x1F605;&#x1F605;</p><p>Anyway&#x2026; the radar images have become an integral part of some peoples&apos; lives. However in <em>my</em> opinion, those radar images are a bit&#x2026; blurry and looks <em>outdated</em>.</p><p>I felt that it needs a new <em>perspective</em>. A new design <em>uplift</em>.</p><p>I think it&apos;s time to move on from raster to vector. &#x1F4A5;&#x1F4A5;&#x1F4A5;</p><p>Here are the <strong>5 essential steps</strong> that I&apos;ve formulated in my head:</p><ol>
<li><strong>Acquire the boundary coordinates for the radar images</strong>. Technically north, south, east and west sides.</li>
<li><strong>Render the radar image on Mapbox GL JS</strong>. I need to see if it really works and looks the same as the one on Weather.gov.sg</li>
<li><strong>Convert radar image to vector</strong>. If I could find any tools to do this, it would be helpful. Else, I&apos;ll need to figure it out with something else.</li>
<li><strong>Render the vector <em>with</em> the radar image on Mapbox GL JS</strong>. Again, to check if it works and looks the same. At least to make sure the conversion and calculations are correct.</li>
<li><strong>Optimizations &amp; improvements</strong>. At this step, things would have been more realistic and I can move on to performance optimizations, feature improvements and design aesthetics.</li>
</ol><h2>Acquire the boundary coordinates for the radar images</h2><p>This step took me a few surprising <em>round-trips</em>.</p><p>On the <a href="http://www.weather.gov.sg/weather-rain-area-50km/">Weather.gov.sg site</a>, there are no information on the boundary coordinates. I didn&apos;t look at the source code and assumed that the site simply overlay the radar image on a Singapore map.</p><p>My first attempt was to sniff the API calls from <a href="https://itunes.apple.com/sg/app/myenv/id444435182?mt=8">myENV iOS app</a>, which is <a href="https://buuuk.com/work/nea">built and designed by the wonderful folks at Buuuk</a>. I&apos;m a fan of their work and thought that it would be cool to see how they worked out with the APIs. I manage to pinpoint to this URL:</p><pre><code>http://cdn.neaaws.com/rain_radar/dpsri_70km_Remove_XXXXXXXXXXXX0000dBR.dpsri.png
</code></pre><p>The <code>XXXXXXXXXXXX</code> value in the URL is a 12-character date-time string, for example <code>201805152335</code> represents 15 May 2018 at 23:35 (11:35PM). The last four zeros probably represents the milliseconds but seems like not needed to be modified. And not sure what <code>dBR</code> means. &#x1F937;&#x200D;&#x2642;&#xFE0F;</p><p>This radar image is a bit different that the one on <a href="http://www.weather.gov.sg/home/">weather.gov.sg</a>:</p><pre><code>http://www.weather.gov.sg/files/rainarea/50km/v2/dpsri_70km_XXXXXXXXXXXX0000dBR.dpsri.png
</code></pre><p>So the former is a 70km radar image, and this one is a 50km image&#x2026; despite the file name has the word <code>70km</code> there. &#x1F605; One is served from <code>cdn.neaaws.com</code> which is obviously hosted on <a href="https://aws.amazon.com/">AWS</a>, and the other is under <code>weather.gov.sg</code> domain. It&apos;s all pretty confusing but throughout my tests,  <code>weather.gov.sg</code> seems to serve the latest radar images much earlier than <code>cdn.neaaws.com</code>.</p><p>Anyway, as I sniff the API calls on myEnv app, I found some coordinates. They are pretty rough, and I&apos;m not sure if they&apos;re accurate, so I tried them out and they kind of worked&#x2026;(?)</p><p>A few weeks later, to my surprise, I discovered that the source code of <a href="http://www.weather.gov.sg/weather-rain-area-50km/">Weather.gov.sg</a> site actually contains the coordinates! In fact, there are 8 coordinates?!?</p><pre><code class="language-javascript">function calculatePosition(basemapImg,latitude,longitude){
	  /* var map_latitude_top = 1.490735;
	  var map_longitude_left = 103.568691;
	  var map_latitude_bottom = 1.177710;
	  var map_longitude_right = 104.134487; */
	var map_latitude_top = 1.4572;
	  var map_longitude_left = 103.565;
	  var map_latitude_bottom = 1.1450;
	  var map_longitude_right = 104.130;
		var width_calibration = 20720;
		var height_calibration = 246;
		var zoom_level_height = 200;
		var zoom_level_width = 200;
		var imgWidth  = basemapImg.width;
		var imgHeight = basemapImg.height;
		var scale		  = imgWidth/100;
...
</code></pre><p>Some of them worked, some don&apos;t. Some of the edges were off by few degrees and don&apos;t look the same as the displayed map image on weather.gov.sg. Obviously at this point, I&apos;m throwing numbers around randomly and trying to get things as accurately as possible.</p><p>It got me thinking; does accuracy even matter at all? Looking at it, the radar images are actually quite low in resolution and some measurements could have been rounded off. The folks maintaining weather.gov.sg might have tweaked the coordinates even further to make it look good on the web site. Do anyone care if the accuracy is off by a few degrees?</p><p>Finally I end up using these values:</p><ul>
<li>Lower latitude = 1.156&#xB0;</li>
<li>Upper latitude = 1.475&#xB0;</li>
<li>Lower longitude = 103.565&#xB0;</li>
<li>Upper longitude = 104.130&#xB0;</li>
</ul><p>Disclaimer: these values <strong>are not accurate</strong>.</p><h2>Convert radar image to vector</h2><p>I have the radar image with width and height information. I have the boundary coordinates for all four sides.</p><p>Theoretically speaking, <a href="http://siliconvalleyism.com/silicon-valley-image.php?id=732">the math is sound</a>.</p><p>I did a little research on the Internet and the only relevant resource that I found is this article: <a href="https://blog.mapbox.com/creating-vector-tiles-from-raster-datasets-f8c9dc652c97">Creating vector tiles from raster datasets</a>. It uses <a href="https://github.com/mapbox/make-surface"><code>make-surface</code></a> for the raster-to-vector conversion with &quot;triangulated&quot; data. It looks pretty cool but the tool does seem a little complicated and much overkill for a <em>tiny</em> region like Singapore. &#x1F605;</p><p>Instead, I did the <em>simplest</em> thing that I could think of: converting every pixel in the radar image into vector coordinates. The radar image is a PNG image, so I did a quick <a href="https://www.npmjs.com/search?q=png%20parser"><code>npm</code> search</a> and voil&#xE0;, <a href="https://github.com/lukeapage/pngjs">pngjs</a> is found.</p><p>The main idea here is to parse the PNG file, loop through every single pixel, extract the color information, convert X and Y coordinates into latitudes and longitudes, generate GeoJSON polygons and lastly output a GeoJSON file. &#x1F4A5;&#x1F4A5;&#x1F4A5;</p><p>I&apos;m generally not going into the details and the <a href="https://github.com/cheeaun/rain-geojson-sg">source code is available</a> &#x1F609;. Those who have learned digital image processing in college/university or did some work with <a href="https://en.wikipedia.org/wiki/Canvas_element">HTML5 canvas</a>, will be able to guess what I did. Those who hasn&apos;t, could start by reading this article, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas">Pixel Manipulation with canvas</a>. &#x1F4AA;</p><h2>Render the vector with the radar image on Mapbox GL JS</h2><figure><img src="/blog/images/screenshots/web/vector-tiles-raster-radar-image-mapbox@2x.png" alt="Vector tiles on top of raster radar image on a map, powered by Mapbox" width="549" height="561"></figure><p>I did a super quick demo page and&#x2026; <a href="https://twitter.com/cheeaun/status/982477428713963527">it worked</a>! &#x1F631; The screenshot above might not show it clearly, but the blurry shadow-like edges around the square shapes is the radar image itself. For the radar images, it becomes blurry when zoomed in. For the GeoJSON vector polygons, it stays sharp. Judging from the squares overlapping on the blurry edges, it proves that the math is correct and the conversion works! &#x1F4AA;</p><h2>Optimizations &amp; improvements</h2><figure><img src="/blog/images/screenshots/web/rain-area-vector-tiles-3d-perspective-mapbox@2x.png" alt="Rain area vector tiles with 3D perspective on Mapbox" width="434" height="612"></figure><p>With <a href="https://www.mapbox.com/mapbox-gl-js/api/">Mapbox GL JS</a>&apos;s features, the polygons can even be <a href="https://twitter.com/cheeaun/status/982555182520086528">viewed with a slanted 3D pitch</a> and applied with different opacity styles!</p><p>Since it&apos;s already viewable in 3D, why not add a little <a href="https://blog.mapbox.com/3d-features-in-mapbox-gl-js-e94734f12110">extrusion</a>? &#x1F929;</p><figure><img src="/blog/images/screenshots/web/rain-area-3d-extrusion-mapbox@2x.png" alt="Rain area with 3D extrusion on Mapbox" width="1094" height="612" loading="lazy" class="large"></figure><figure><img src="/blog/images/screenshots/web/rain-area-3d-extrusion-close-up-mapbox@2x.png" alt="Rain area in 3D extrusion, close-up version, on Mapbox" width="1064" height="622" loading="lazy" class="large"></figure><p>For this extrusion feature to work, I need more than color information from the radar image. Basically, higher rain intensity (heavier) translates to higher 3D extrusions (taller).</p><p>Here&apos;s a relatively simple diagram:</p><figure><img src="/blog/images/figures/diagram/legend-rain-area-colors-extraction-intensity-values-maps.png" alt="Legend of rain intensity with colors, extracted as intensity values, to be rendered on maps" width="640" height="1520"></figure><p>I took the first step in color-picking the rain intensity legend on <a href="http://www.weather.gov.sg/weather-rain-area-50km/">weather.gov.sg</a>. It&apos;s a bit rough and may not match the colors found from the radar image, so I use a library called <a href="https://github.com/dtao/nearest-color"><code>nearest-color</code></a> to <em>map</em> the colors to the list of colors that I picked. For example, if the color on the radar image is <code>#40FFFE</code>, then it&apos;ll be mapped to <code>#40FFFD</code> from the <code>intensityColors</code> list.</p><p>From the intensity colors list, I only have colors but I don&apos;t have any scientific values for rain intensity. From <a href="http://www.weather.gov.sg/learn_observations/">weather.gov.sg</a>, the rainfall measurement section explains:</p><blockquote>
<p>MSS uses the tipping bucket rain gauge, which uses a seesaw mechanism to measure both the amount and intensity of rainfall &#x2014; when rain fills one end of the &#x2018;bucket&#x2019; to the brim, it tips over and is recorded as a quantum unit of rainfall (e.g. 0.1 mm). The more the &#x2018;bucket&#x2019; tips from side to side, the higher the amount of measured rainfall. The faster the &#x2018;bucket&#x2019; tips from side to side, the higher the intensity of measured rainfall.</p>
</blockquote><p>I guess&#x2026; this is a little complicated, so I did a super simple <em>assumption</em> by assigning ranged values from 0 to 100, where 0 is for least intensity (aqua) and 100 is for highest intensity (pink). Moderate intensity (green or yellow) would have values around 50.</p><pre><code class="language-json">{
	&quot;type&quot;: &quot;Feature&quot;,
	&quot;properties&quot;: {
		&quot;color&quot;: &quot;#00efef&quot;,
		&quot;intensity&quot;: 7
	},
	&quot;geometry&quot;: {
		&quot;type&quot;: &quot;Polygon&quot;,
		&quot;coordinates&quot;: [...]
	}
}
</code></pre><p>Each GeoJSON polygon contains two values; <code>color</code> in hexadecimal format and <code>intensity</code> in numbers ranging from 0 to 100. Using these values, I could apply them to the 3D extrusions of the polygons. The Mapbox style expression looks like this:</p><pre><code class="language-javascript">&apos;fill-extrusion-height&apos;: [&apos;*&apos;, 50, [&apos;get&apos;, &apos;intensity&apos;]]
</code></pre><p>The height of extrusion is further multiplied by 50 to make them look more awesome on the 3D map. &#x1F4A5;</p><p>After that, I realised that some of the square polygons of the same colors are <em>duplicated</em> on the map. The dimension of the radar image is 217&#xD7;120, which means the GeoJSON file will contain a maximum of 26,040 polygons, which results in 26,040 squares/cubes to be rendered on the map. I could perhaps reduce the number of polygons by merging polygons with the same color/intensity.</p><p>I tried using <a href="http://turfjs.org/docs/#union">Turf.js union</a> and <a href="https://github.com/w8r/martinez">martinez</a> which can perform union operation on polygons, but to no avail. Somehow the polygons are merged in a weird way which I have no idea what happened. I tried a few other solutions and finally manage to make it work with <a href="https://github.com/mfogel/polygon-clipping">polygon-clipping</a>.</p><figure><img src="/blog/images/figures/diagram/multiple-polygons-merged-multipolygons-map@2x.png" alt="Multiple polygons becomes merged MultiPolygons, on a map" width="438" height="670"></figure><p>In this step, I&apos;m killing two birds with one stone:</p><ol>
<li>The number of polygons are reduced. Any adjacent polygons with the same color will be merged into a single polygon.</li>
<li>All polygons with the same color are grouped together into a <code>MultiPolygon</code>, one of the <a href="https://en.wikipedia.org/wiki/GeoJSON#Geometries">interesting geometries in GeoJSON</a>.</li>
</ol><p>This <a href="https://twitter.com/cheeaun/status/982932686397366274">optimization</a> reduced the number of polygons, resulting in smaller file size and better rendering performance.</p><p>On 8 April, I <a href="https://twitter.com/cheeaun/status/982997632812380161">open-sourced</a> my work on converting the rainfall radar images to GeoJSON, on <a href="https://github.com/cheeaun/">GitHub</a>. &#x1F680;</p><h2>The unexpected final step</h2><p>So my <a href="https://en.wikipedia.org/wiki/Proof_of_concept">Proof of Concept</a> works and... my job is done! &#x1F64C;</p><p>This is when I thought to myself, should I build a web app out of this? Is this going to be &quot;Yet Another Weather App&quot; (YAWA)? Am I going to register another SG domain again? Who&apos;s going to use this app? Is this any better than <a href="http://www.weather.gov.sg/">weather.gov.sg</a>?</p><p>Whatever, I built it anyway. I showed <a href="https://twitter.com/cheeaun/status/983160181084241925">a sneak peek on 9 April</a>.</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-sneak-peek-clouds-weather-info@2x.png" alt="Check Weather SG sneak peek showing clouds and weather information" width="1275" height="645" loading="lazy" class="large"></figure><p>In this screenshot, there are tiny specks of clouds in aqua-ish colors. I manage to integrate additional weather information such as <a href="http://www.weather.gov.sg/weather-currentobservations-temperature/">temperature</a>, <a href="http://www.weather.gov.sg/weather-currentobservations-rainfall">rainfall</a>, <a href="http://www.weather.gov.sg/weather-currentobservations-relative-humidity">relative humidity</a> and <a href="http://www.weather.gov.sg/weather-currentobservations-wind">wind</a> (direction); each of them only visible at certain zoom levels so that the user won&apos;t be bombarded by lots of numbers on the map. To onboard new users, I add a simple legend panel at the bottom right.</p><p>It took roughly 5 days to test it myself, as I kept tweaking every little detail and <a href="https://twitter.com/cheeaun/status/985161104073437185">adding the finishing touches</a>.</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-site-2d.png" alt="Check Weather SG site, in 2D" width="1334" height="750" class="large"></figure><p>The legend panel is readjusted to take less space.</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-site-3d.png" alt="Check Weather SG site, in 3D" width="1334" height="750" class="large"></figure><p>&quot;3D mode&quot; can be triggered via the &apos;3D&apos; button on the right. Tapping it multiple times will adjust the tilt (pitch) of the map. Polygons are extruded with heights based on their rain intensity values.</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-site-clouds.png" alt="Check Weather SG site, showing clouds in 3D" width="1334" height="750" class="large"></figure><p>This &quot;Cloud mode&quot; is perhaps the coolest thing I ever came up with.</p><p>Technically speaking, it&apos;s quite similar to &quot;3D mode&quot; but I have to change the <strong>elevation</strong> and <strong>height</strong> (extrusion) of the polygons. The elevation values (height of clouds from land base) are not accurate and purely estimated.</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-3d-cloud-rain-shadow.png" alt="Check Weather SG, showing a 3D cloud with rain patterns and drop shadow" width="806" height="852"></figure><p>The patch of clouds are <em>literally</em> floating on the map as they can cover the map labels <em>behind</em> them. There are rain patterns made possible via the <a href="https://www.mapbox.com/mapbox-gl-js/style-spec/#paint-fill-extrusion-fill-extrusion-pattern"><code>fill-extrusion-pattern</code> style</a>, which are <em>actually</em> 3D polygons with <em>fixed</em> heights from the bottom of the clouds to the land base. Assuming that the sun&apos;s position is always at the top, a few more (2D) polygons are added at the base to simulate subtle drop shadows. If I take the wind direction into account, I probably could have tilted the rain drops but&#x2026; let&apos;s leave that for another day. &#x1F604;</p><p>On <a href="https://twitter.com/cheeaun/status/985405046937432064">15 April</a>, I launched <a href="https://checkweather.sg/">Check Weather SG</a> to the public. &#x1F680; It&apos;s also <a href="https://github.com/cheeaun/checkweather-sg">open-sourced on GitHub</a>. There were a few hiccups in the beginning but I manage to iron them out pretty quickly.</p><p>Once in a while, I like <a href="https://twitter.com/cheeaun/status/986848547302555648">tweeting nice screenshots</a> and <a href="https://twitter.com/cheeaun/status/999304424244658176">discover bugs</a> like this:</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-rain-covers-whole-singapore@2x.png" alt="Check Weather SG showing rain that covers the whole Singapore" width="375" height="667"></figure><p>So when it&apos;s raining all over the place, users can&apos;t really see Singapore anymore &#x1F605;.</p><p>Few days later, I <a href="https://twitter.com/cheeaun/status/1002698753097097216">fixed it</a> by applying opacity based on rain intensity. So, low intensity areas (aqua) will be less visible and high intensity areas will be more visible (pink). I agree that it&apos;s not the best solution, but it works for now. One possible flaw would be, what if it&apos;s heavy rain (pink) all over the area, which will still end up hiding the whole Singapore &#x1F605;.</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-rain-intensity-opacity-timestamp@2x.png" alt="Check Weather SG showing rain intensity affecting the opacity of the polygons. Also showing a timestamp at the top left." width="667" height="375"></figure><p>I&apos;ve also added a timestamp at the top left to indicate the time of the radar image snapshot, which is roughly generated and will be updated every 5 minutes.</p><p>One frequently requested feature that I <strong>did not</strong> implement is the playback animation of past radar images. From my personal testing and judgement, I never manage to forecast the rain areas based on the animation, which explains my lack of enthusiasm in implementing this feature. &#x1F60F; Somehow I find the wind direction arrows are more useful? &#x1F937;&#x200D;&#x2642;&#xFE0F; Also, implementing a playback UI is not easy in my opinion. Even though it <em>can</em> be done, like the ones on those weather sites, but I always find them too distracting or animating too fast. &#x1F605;</p><p>Lastly, I felt proud <em>and</em> sad at the same time, that <strong>no one</strong> found a <em>hidden</em> feature on <a href="https://checkweather.sg/">Check Weather SG</a>:</p><figure><img src="/blog/images/screenshots/web/check-weather-sg-wind-arrow-hidden-compass.png" alt="Check Weather SG, legend panel showing the wind direction arrow which is actually a hidden compass" width="638" height="259"></figure><p>The arrow is the same as the blue &quot;current location&quot; arrowhead on Google Maps, pointing to the direction the phone (or any compass-supported devices) moved, relative to the map. On devices without compass support, it&apos;ll keep spinning slowly and infinitely. &#x1F602;</p><p>As time goes by, I&apos;ve gotten more and more fond of the domain and app name. Like my previous project, <a href="/blog/2018/04/building-exploretrees-sg">ExploreTrees.SG</a>, I did the same naming trick of appending a verb to the word &apos;weather&apos; (noun). It took me quite a few days to figure out a suitable verb that is easy to say and sounds natural at the same time.</p><p>So the next time you want to check the weather in Singapore, just go to <a href="https://checkweather.sg/">checkweather.sg</a>! &#x1F4A5;&#x1F609;</p></div>
      </article>
  </div>
  <footer>
    <nav>
      <ul>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/projects/">Projects</a></li>
        <li><a href="/about/">About</a></li>
      </ul>
    </nav>
  </footer></div>
<script>
  window.onload = function () {
    // Auto float images
    var $figures = document.getElementsByTagName('figure');
    if (!$figures.length) return;
    function asideImages () {
      for (var i = 0, l = $figures.length; i < l; i++) {
        var $figure = $figures[i];
        var $images = $figure.getElementsByTagName('img');
        if ($images.length == 1) {
          var $img = $images[0];
          var width = Math.max($img.naturalWidth, $img.width);
          var height = Math.max($img.naturalHeight, $img.height);
          if (width <= 280 && (width / $figure.parentNode.offsetWidth * 100 < 50) && height < window.innerHeight * 0.9) {
            $figure.className = 'image-aside';
          } else if ($figure.className) {
            $figure.className = '';
          }
        }
      }
    };
    asideImages();
    window.onresize = asideImages;

    // Autoplay videos when in viewport
    // https://benfrain.com/automatically-play-and-pause-video-as-it-enters-and-leaves-the-viewport-screen/
    function playPauseVideo() {
      var videos = document.querySelectorAll("video");
      videos.forEach((video) => {
        video.muted = true;
        var playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise.then((_) => {
            var observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    video.play();
                  } else {
                    video.pause();
                  }
                });
              },
              { threshold: 0.2 }
            );
            observer.observe(video);
          });
        }
      });
    }
    playPauseVideo();
  };
  if (navigator.serviceWorker) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('/sw.js', {
        scope: '/'
      });
    });
  }
</script>
<script data-goatcounter="https://cheeaun.goatcounter.com/count" async src="//gc.zgo.at/count.v2.js" crossorigin="anonymous" integrity="sha384-PeYXrhTyEaBBz91ANMgpSbfN1kjioQNPHNDbMvevUVLJoWrVEjDCpKb71TehNAlj"></script>
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "56009c05c6234036a216843af8874520"}'></script><!-- End Cloudflare Web Analytics -->
</html>