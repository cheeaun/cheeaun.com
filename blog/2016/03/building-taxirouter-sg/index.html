<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>Building TaxiRouter SG &ndash; Lim Chee Aun</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/assets/cheeaun.css?167k9wi">
<link rel="preload" href="/assets/fonts/WorkSans-Regular.woff2" as="font" type="font/woff2">
<meta name="twitter:card" content="summary">
<meta property="og:title" content="Building TaxiRouter SG">
<meta name="description" property="og:description" content="For some reason, I check my GitHub news feed regularly and really like to know what my followings are starring, forking, pull-requesting, creatingâ€¦">
<meta property="og:image" content="https://cheeaun.com/blog/images/screenshots/web/uzyn-taxisg-singapore-taxi-data-visualization.png">
<link rel="alternate" href="/blog/feed.xml" type="application/atom+xml" title="cheeaunblog">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="apple-touch-icon" href="/assets/images/icon-192.png">
<meta name="color-scheme" content="light dark"><div id="container">
  <header role="banner">
    <h1>
      <a href="/"><svg width="120" height="120" viewBox="0 0 225 225">
    <title>Lim Chee Aun</title>
    <circle cx="112.5" cy="112.5" r="112.5" fill="#fa8e01"/>
    <path fill="#fff" d="M104.8 127.1c-.8.4-1.9.9-3 1.3-1.2.5-2.4.9-3.6 1.2-1.2.3-2.3.5-3.3.5-3 0-5.3-1.5-7-4.7-1.6-3.1-2.5-7.8-2.5-13.9 0-4.3.4-7.6 1.2-9.9.7-2.3 1.8-4 3.2-4.9 1.3-1 2.9-1.4 4.7-1.3 1.2-.1 2.7.1 4.4.5 1.8.4 3.7 1.1 5.7 2.2l3.3-15.5c-2.7-.9-5.3-1.5-8-1.9-2.5-.3-4.8-.5-6.8-.5-5.8 0-10.7 1.1-14.8 3.3-4.1 2.2-7.2 5.7-9.4 10.7-2.1 4.8-3.2 11.2-3.3 19.2 0 10.8 2.1 18.8 6.3 24 4.1 5.2 10.2 7.8 18.3 7.8 2.2 0 4.4-.1 6.6-.5 2.2-.3 4.3-.8 6.3-1.4 2-.6 3.7-1.3 5.2-2.1l-3.5-14.1zm54.5 16.9c-.2-1.8-.5-3.8-.8-6.1-.2-2.2-.4-4.5-.6-7-.2-2.4-.3-4.9-.3-7.3v-23c0-2.9-.3-5.6-1-8.1-.6-2.5-1.8-4.7-3.3-6.6-1.6-1.9-3.9-3.4-6.7-4.5-2.8-1-6.3-1.6-10.6-1.6-3.5 0-7.1.4-10.7 1.1-3.6.8-7.3 1.8-11 3.1l3.7 14c3.1-1.2 5.8-2.1 8.2-2.8 2.5-.6 4.5-.9 6.1-.9 1.8 0 3.3.5 4.4 1.4 1.2 1 1.8 2.6 1.8 4.9v7.7c-3.8.3-7.2.8-10.4 1.6s-6 1.9-8.4 3.3c-2.4 1.5-4.3 3.4-5.7 5.8-1.3 2.3-2 5.1-2 8.5 0 2.3.2 4.5.7 6.7.5 2.1 1.3 4 2.4 5.6 1.1 1.7 2.5 3 4.1 3.9 1.7 1 3.6 1.5 5.9 1.5 2.6 0 4.9-.4 6.9-1.2 2.1-.8 3.9-1.8 5.6-2.9 1.6-1.1 3.1-2.2 4.6-3.3l1.5 6.2h15.6zm-20.7-14.9c-.9.8-1.8 1.4-2.6 1.9s-1.6.7-2.5.7c-1.4 0-2.5-.6-3.4-1.8-.8-1.2-1.3-2.8-1.3-5 0-1.7.5-2.9 1.4-3.8 1-.8 2.2-1.4 3.7-1.7 1.5-.3 3-.6 4.7-.7v10.4z"/>
    <circle cx="112.5" cy="112.5" r="83.7" fill="none" stroke="#fff" stroke-width="20.1"/>
  </svg>
  </a>
    </h1>
  </header>
  <div id="content">
    <article itemscope itemtype="http://schema.org/BlogPosting">
      <header><h1 itemprop="heading">Building TaxiRouter SG</h1><time datetime="2016-03-29" class="meta date" itemprop="datePublished">29 March 2016</time></header><div itemprop="articleBody"><figure><a href="https://taxirouter.sg/"><img src="/blog/images/screenshots/web/taxirouter-sg-web-site@2x.png" alt="TaxiRouter SG web site" width="568" height="320" loading="lazy"></a></figure><p>For some reason, I check my <a href="https://github.com/">GitHub</a> news feed regularly and really like to know what my followings are starring, forking, pull-requesting, creating and open-sourcing. It&apos;s like Twitter, but for public projects and repositories.</p><p>On 18 March 2016, I found that <a href="https://github.com/kahwee">Kah Wee</a> started watching <a href="https://github.com/uzyn">U-Zyn Chua</a>&apos;s new repository called <a href="https://github.com/uzyn/taxisg">taxisg</a>. I was curious and clicked to find a really awesome project that <a href="http://uzyn.github.io/taxisg/">visualizes the Singapore taxi data</a>, with snapshots of historical data and live heatmap visualization for thousands of available taxi locations on a map.</p><figure><a href="http://uzyn.github.io/taxisg/"><img src="/blog/images/screenshots/web/uzyn-taxisg-singapore-taxi-data-visualization.png" alt="U-zyn&apos;s TaxiSG site: Singapore Taxi Data Visualization" width="800" height="1111" loading="lazy"></a></figure><p>U-Zyn also <a href="https://speakerdeck.com/uzyn/uncovering-of-an-obfuscated-public-governmental-api-foss-asia-2016">gave a talk</a> during the <a href="http://2016.fossasia.org/">FOSSASIA 2016</a> conference on 18 March, the same day I discovered the project.</p><p>Here&apos;s a few brief highlights from his talk:</p><ul>
<li>Taxi-Taxi@SG app by the Land Transport Authority (LTA) is <a href="https://www.techinasia.com/taxi-app-singapores-transport-agency-stunningly-pointless">stunningly pointless</a>, compared to other taxi booking apps.</li>
<li>Despite its <em>pointlessness</em>, the app actually shows <strong>realtime</strong> taxi locations!</li>
<li>API endpoint hunting begins, with <strong>lots of technical surprises</strong>. (No spoilers here, <a href="https://speakerdeck.com/uzyn/uncovering-of-an-obfuscated-public-governmental-api-foss-asia-2016">check out his slides</a> which contain very cute photos &#x1F60A;)</li>
<li>Data mining begins after that with a few discoveries, for example the airport is always packed and Singapore Zoo (Night Safari) closes at midnight.</li>
<li>Single-page application front-end with serverless architecture, using <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> and <a href="https://aws.amazon.com/dynamodb/">Amazon DynamoDB</a>.</li>
</ul><p>Coincidentally, <a href="https://data.gov.sg/">Data.gov.sg</a> opened up the <a href="https://developers.data.gov.sg/datagovsg-apis/apis/get/transport/taxi-availability">same (public) API</a> on the same day!</p><p>It&apos;s <strong>really exciting</strong> to see such awesome realtime data and I just can&apos;t stop myself from trying it out. Later in the evening, also on the same day, I experimented with the API and <a href="https://twitter.com/cheeaun/status/710841970747252736">came up with this</a>:</p><figure><a href="https://twitter.com/cheeaun/status/710841970747252736"><img src="/blog/images/screenshots/web/available-taxi-location-markers-map-singapore@2x.png" alt="Available taxi location markers plotted on a map in Singapore" width="500" height="257" loading="lazy"></a></figure><p>More than <strong>5 thousand markers</strong> are plotted on the map. Auto-refresh every 60 seconds. Pretty mind-blowing.</p><p>On the next day, I tried <a href="https://twitter.com/cheeaun/status/711155044490420230">replaying the markers in a time-lapse fashion</a> and got to say, the dots were <a href="https://twitter.com/lg/status/711232681497858049">too random</a> to be useful. The API only returns a list of geographical coordinates so I don&apos;t know which taxi moves to which position in the next minute. Keep in mind that the list contains only <strong>available</strong> taxis which means that if a taxi is taken, it will disappear from the list. Vice versa, if a taxi drops off a passenger, it will become available and appear again in the list. Even though the API is so-called <em>realtime</em>, 60 second interval is not enough to even simulate <em>movement</em> of the vehicles on a map.</p><p>Instead of <em>visualizing</em> the data, I try to see what&apos;s the best I could do from the dataset to be at least <strong>useful</strong> for people. Useful in the sense that you could use it while walking on the streets, either as a local or a tourist in Singapore.</p><p>I made a decision to build a super simple web app that tells the user <strong>how many</strong> available taxis nearby and where&apos;s the <strong>nearest</strong> taxi stand. That&apos;s it. It&apos;s not a taxi booking app. Instead of the taxi go to you, you go to the taxi. Very classic, right? Well at least now, users can roughly guess where&apos;s the &quot;busy&quot; area, avoid them, and figure out where all the other taxis are &quot;hiding&quot;.</p><h2>Designing the markers</h2><p>On 21 March, I continued puting some nice touches on the markers and further <a href="https://twitter.com/cheeaun/status/711725043017854976">polishing the details</a>:</p><figure><a href="https://twitter.com/cheeaun/status/711725043017854976"><img src="/blog/images/screenshots/web/available-taxi-location-taxi-stands-markers-map-singapore@2x.png" alt="Available taxi locations and taxi stands plotted on a map in Singapore" width="511" height="653" loading="lazy"></a></figure><p>The marker designs went through a few short iterations as I keep trying out different colors and styles. They have to work well with the default tiles styling of Google Maps. They have to look <em>familiar</em> as in yellow being a recognizable color for taxis, even though <a href="https://en.wikipedia.org/wiki/Taxicabs_of_Singapore">taxis in Singapore</a> are also painted in red, blue, brown, silver, copper, black and white. The taxi and taxi stand have to look different while having the taxi glyph in them.</p><figure><img src="/blog/images/artwork/icons/taxirouter-sg-markers.svg" alt="Marker designs for TaxiRouter SG" width="800" height="300"></figure><p>I started with simple circles, which later I find them too plain and <em>static</em>. The taxi markers are <em>dynamic</em> and constantly on the move. A plain circle simply doesn&apos;t cut it.</p><p>So I decided that a taxi marker has to look like a taxi, which is more straight-to-the-point and hopefully shows that it&apos;s a <em>moving</em> target. I did a quick pixel art of the front view of a taxi vehicle, with a dark outline, so that there&apos;s more contrast, especially where a lot of taxis flock together in the same spot. I tweaked the outline opacity a few times until I get the right balance, roughly based on how the taxis flock together on the map. I&apos;ve also tried making the headlights more visible within the yellow background of the car, by introducing a few artifacts around them.</p><p>The fourth icon, with black-colored taxi and yellow background, was meant to be a taxi stand, purposely designed to have inversed colors from the taxi icon. I tried plotting it on Google Maps and found it really difficult to differentiate between the taxi and the stand.</p><p>I ended up making the taxi stand to look like, again, a taxi stand. It&apos;s way bigger than a taxi marker, with the anchor point at the bottom center. It&apos;s a non-moving target, so making it look like a pin makes sense. I use the taxi icon from Google&apos;s <a href="https://design.google.com/icons/">Material icons</a>, which is also used as the logo of the site.</p><h2>Getting rid of flicker</h2><p>During the first phase of development, the app basically fetches the API response and draw all the thousands of markers with the <a href="https://developers.google.com/maps/documentation/javascript/">Google Maps JavaScript API</a>. The polling happens every minute and each time, it will fetch the API response again, destroy all markers and redraw them again. It results in flickering of markers, which they disappears briefly and reappears again. Kind of jarring and <em>feels</em> slow.</p><p>I use the Google Maps Javascript API a lot in my past projects. The usual solution for &quot;<a href="https://developers.google.com/maps/articles/toomanymarkers">Too Many Markers</a>&quot; problem is always <em>not</em> displaying all of them at once.</p><p>This time, I&apos;m taking the plunge and try to somehow work things out. 5000+ markers on the map, every minute, without flickering.</p><p>The <strong>first step</strong> is to compare the differences between the current list of coordinates and the subsequent list. Technically speaking, just <code>diff</code> it.</p><figure><img src="/blog/images/figures/diagram/taxis-diff-same-removed-added@2x.png" alt="Compare differences between taxis data and separated into &quot;removed&quot; and &quot;added&quot;" width="540" height="210"></figure><p>Let&apos;s say the first poll contains 5000 taxis and next poll contains 6000. At this point, 5000 markers are already drawn on the map. Now I need to see the next list of coordinates and check if some of the coordinates are <em>changed</em> from the first list.</p><p>At first, I was expecting that the chances of taxis staying at the same coordinates would be very, very low. It turns out that, during my first attempt, there was about 2000 taxis out of 5000 that <strong>did not move from their location</strong> at all! I&apos;m not even <em>intelligently</em> comparing the coordinates, just a basic strict comparison of exact latitudes and longitudes. Eventually, I could leave the 2000 markers untouched and only operate on the changed ones.</p><p>I separate the changed markers into two buckets: &quot;removed&quot; and &quot;added&quot;.</p><figure><img src="/blog/images/figures/diagram/taxis-diff-remove-marker-map@2x.png" alt="Excess of &quot;Removed&quot; markers are removed from map" width="350" height="240"></figure><p>The <strong>second step</strong> is to deal with the &quot;removed&quot; markers. If the number of &quot;removed&quot; markers is more than &quot;added&quot; ones, the code will simply remove the markers from the map, which hopefully could reduce memory usage in the browser.</p><figure><img src="/blog/images/figures/diagram/taxis-diff-create-new-marker@2x.png" alt="Addtions of &quot;Added&quot; markers are created as new markers. &quot;Removed&quot; markers move to the position of &quot;Added&quot; markers." width="450" height="210"></figure><p>If the number of  &quot;added&quot; markers is more than &quot;removed&quot;, the code will create new markers and plot them on the map.</p><p>The <strong>third step</strong> now is to reset the &quot;removed&quot; markers&apos; positions to the coordinates of the &quot;added&quot; markers. I think here is the <em>magical</em> part which prevents the flickering problem. Instead of removing and readding markers, I basically &quot;reuse&quot; the existing markers.</p><p>Mission accomplished.</p><h2>Observing the data</h2><figure><img src="/blog/images/screenshots/web/taxis-faded-stationary-map@2x.png" alt="Taxi markers on map, some faded which means they are stationary" width="500" height="300" loading="lazy"></figure><p>After fixing the flickering problem, the stationary taxis count really caught my attention. I <strong>purposely</strong> render them differently by fading out the markers, with 50% opacity, trying to figure out <em>more</em> details. Why are they stationary and not moving at all after 60 seconds?</p><p>Few possible reasons that I could think of:</p><ul>
<li>The taxi drivers are waiting for their passengers in the parking lot.</li>
<li>They left the car parked and went for lunch or dinner.</li>
<li>They are stuck in a heavy traffic.</li>
<li>They are waiting in line at the taxi stand.</li>
<li>They forgot to turn off their GPS device or something.</li>
<li>Their GPS device doesn&apos;t update every 60 seconds, but probably longer than that.</li>
<li>They got into an accident?</li>
</ul><p>Anyway, I don&apos;t really have the final answer.</p><p>Oh yeah, I couldn&apos;t help myself noticing this one taxi being stuck on the ECP (East Coast Parkway) highway bridge. It&apos;s been stationary there for like few days now:</p><figure><img src="/blog/images/screenshots/web/taxi-stuck-ecp-highway-bridge@2x.png" alt="Taxi stuck at ECP highway bridge" width="500" height="310"></figure><p>There is one more interesting surprise in the dataset. Sometimes, the response contains <strong>two</strong> exactly same coordinates in the list. It&apos;s usually around <em>five</em> pairs of same coordinates per request. I don&apos;t quite understand why, but I guess, either the taxis are <em>very</em> near to one another, or they just overlap on top of each other.</p><figure><img src="/blog/images/screenshots/web/duplicated-coordinates-taxi-locations-data@2x.png" alt="Duplicated coordinates in the taxi locations data" width="500" height="170"></figure><p>&#xAF;\_(&#x30C4;)_/&#xAF;</p><h2>The launch</h2><p>On 24 March 2016, 6 days after inception, I <a href="https://twitter.com/cheeaun/status/712809348230066176">launched TaxiRouter SG</a> <a href="https://www.facebook.com/cheeaun/posts/10153872232651294">to the public</a>. It&apos;s <a href="https://github.com/cheeaun/taxirouter-sg">open-sourced on GitHub</a> and even has its <a href="https://twitter.com/taxiroutersg">own Twitter account</a>.</p><p>Overall, it took me 7 days from idea to launch, which I&apos;m quite surprised myself. I hope that this app would be useful for everyone, including locals and tourists. Any feedback is <a href="https://twitter.com/cheeaun">always welcomed</a>.</p><p>TaxiRouter SG now joins my <em>collection</em> of public transportation apps for Singapore, with the almighty <a href="https://busrouter.sg/">BusRouter SG</a> and the <a href="https://twitter.com/cheeaun/status/687826686625198080">quite-recently-launched</a> <a href="https://railrouter.sg/">RailRouter SG</a>.</p><p><a href="https://twitter.com/sayanee_/status/712866961370308608">As tweeted</a> by Sayanee:</p><blockquote>
<p><a href="https://twitter.com/_fadhli">@_fadhli</a> how can we go around Singapore effectively without <a href="https://twitter.com/cheeaun">@cheeaun</a>&apos;s apps? &#x1F917; &#x1F686; &#x1F694; &#x1F68C;</p>
</blockquote><p>Exactly.</p></div>
      </article>
  </div>
  <footer>
    <nav>
      <ul>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/projects/">Projects</a></li>
        <li><a href="/about/">About</a></li>
      </ul>
    </nav>
  </footer></div>
<script>
  window.onload = function () {
    // Auto float images
    var $figures = document.getElementsByTagName('figure');
    if (!$figures.length) return;
    function asideImages () {
      for (var i = 0, l = $figures.length; i < l; i++) {
        var $figure = $figures[i];
        var $images = $figure.getElementsByTagName('img');
        if ($images.length == 1) {
          var $img = $images[0];
          var width = Math.max($img.naturalWidth, $img.width);
          var height = Math.max($img.naturalHeight, $img.height);
          if (width <= 280 && (width / $figure.parentNode.offsetWidth * 100 < 50) && height < window.innerHeight * 0.9) {
            $figure.className = 'image-aside';
          } else if ($figure.className) {
            $figure.className = '';
          }
        }
      }
    };
    asideImages();
    window.onresize = asideImages;

    // Autoplay videos when in viewport
    // https://benfrain.com/automatically-play-and-pause-video-as-it-enters-and-leaves-the-viewport-screen/
    function playPauseVideo() {
      var videos = document.querySelectorAll("video");
      videos.forEach((video) => {
        video.muted = true;
        var playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise.then((_) => {
            var observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    video.play();
                  } else {
                    video.pause();
                  }
                });
              },
              { threshold: 0.2 }
            );
            observer.observe(video);
          });
        }
      });
    }
    playPauseVideo();
  };
  if (navigator.serviceWorker) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('/sw.js', {
        scope: '/'
      });
    });
  }
</script>
<script data-goatcounter="https://cheeaun.goatcounter.com/count" async src="//gc.zgo.at/count.v2.js" crossorigin="anonymous" integrity="sha384-PeYXrhTyEaBBz91ANMgpSbfN1kjioQNPHNDbMvevUVLJoWrVEjDCpKb71TehNAlj"></script>
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "56009c05c6234036a216843af8874520"}'></script><!-- End Cloudflare Web Analytics -->
</html>